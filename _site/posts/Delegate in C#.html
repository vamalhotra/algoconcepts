<!DOCTYPE html>
<html>

<body>
    <h1 id="delegate-in-c">Delegate in C#</h1>

<p>Delegates in C# are similar to function pointer in C++. A function pointer can hold reference to a function and can be invoked with arguments, if any, just like a function.</p>

<p>This article talks about delegates, and generic delegates namely Action and Func which was introduced with C# 3.0. We will also discuss about Predicate which is a special delegate. Finally, we will talk about events and how delegates are useful to define the signature of event handler in subscriber class.</p>

<h2 id="delegate">Delegate</h2>

<p>Delegates in C# inherit from System.MulticastDelegate (which inherits from System.Delegate and, in turn, from System.Object). This class provides a linked list of delegates which are invoked synchronously in order.</p>

<h3 id="using-named-functions">Using named functions:</h3>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//declare delegate aka function pointer which can </span>
    <span class="c1">//point to a function which returns void and takes no arguments</span>
    <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">Function</span><span class="p">();</span>

    <span class="c1">//declare named function</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteInformation</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Got Here"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">CallFunction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Assign named function to delegate.</span>
        <span class="c1">//Signature of delegate and named function should match</span>
        <span class="c1">//thus, providing type safety.</span>
        <span class="n">Function</span> <span class="n">function</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Function</span><span class="p">(</span><span class="n">WriteInformation</span><span class="p">);</span>
        <span class="nf">function</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>Delegates can be combined by calling the Delegate.Combine method, and it must be invoked through the DynamicInvoke() method. The delegates are invoked synchronously in the order in which they appear in Combine(). If an error occurs during execution, an exception is thrown.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteInformation2</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Write Information 2"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">CallFunction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Function</span> <span class="n">function</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Function</span><span class="p">(</span><span class="n">WriteInformation</span><span class="p">);</span>
        <span class="n">Function</span> <span class="n">function2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Function</span><span class="p">(</span><span class="n">WriteInformation2</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">del</span> <span class="p">=</span> <span class="n">Delegate</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">function2</span><span class="p">);</span>
        <span class="n">del</span><span class="p">.</span><span class="nf">DynamicInvoke</span><span class="p">();</span>
        <span class="nf">function</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>
<h3 id="using-anonymous-methods">Using Anonymous methods</h3>

<p>Instead of created a named function, we can often write an anonymous method inline. If anonymous method uses any variable defined in the function, its reference would be retained until the delegate/function-pointer is valid.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">Function</span><span class="p">(</span><span class="kt">string</span> <span class="n">info</span><span class="p">);</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">CallFunction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Function</span> <span class="n">function</span> <span class="p">=</span> <span class="k">delegate</span> <span class="p">(</span><span class="kt">string</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="p">};</span>
    <span class="nf">function</span><span class="p">(</span><span class="s">"This method is anonymous"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="generic-delegates">Generic Delegates</h2>

<p>The above code created custom delegate which takes string parameter. C# 3.0 introduced generic delegates which can take generic parameter. It introduced two generic delegate types <code class="language-plaintext highlighter-rouge">Func</code> and <code class="language-plaintext highlighter-rouge">Action</code></p>

<p>Func is a generic delegate included in the <code class="language-plaintext highlighter-rouge">System</code> namespace. It has zero or more <em>input</em> parameters and one <em>out</em> parameter. The last parameter is considered as an out parameter.</p>

<p>An Action type delegate is the same as <strong><em>Func</em></strong> delegate except that the Action delegate doesn’t return a value. In other words, an Action delegate can be used with a method that has a void return type.</p>

<h3 id="action">Action</h3>

<p>Using Action, you do not need to declare delegate.  Action delegate can have 0 to 16 input parameters.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*public delegate void Function(string s); Not needed */
    
//declare named function
public void WriteInformation(string s)
{
    Debug.WriteLine(s);
}

public void CallFunction()
{
    /*Function function = new Function(WriteInformation);*/
    //Initializing action by directly assigning method
    Action&lt;string&gt; actionDelegate = WriteInformation;
    actionDelegate('Action delegate');
    
    //Initializing action using new keyword
    Action&lt;string&gt; actionDelegate2 = new Action&lt;string&gt;(WriteInformation);
    actionDelegate2('Same as above')
    
    //Initializing action using anonymous method
    Action&lt;string&gt; actionDelegate3 = delegate(string s){ Debug.WriteLine(s);};
    actionDelegate3('Action using Anonymous method')
    
    //Initializing action using lambda method
    Action&lt;string&gt; actionDelegate4 = s =&gt; Debug.WriteLine(s);
    actionDelegate4('Action using lambda method')
} ### Func
</code></pre></div></div>

<p>In below code, sum and SomeOperation are equivalent and both can hold a function pointer that takes two integers and return an integer.
In Func, last parameter is the output type and remaining parameters are input.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Declaring a delegate</span>
<span class="k">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="nf">SomeOperation</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">);</span>

<span class="c1">//Using Func without declaring delegate</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">sum</span><span class="p">;</span>
</code></pre></div></div>

<p>Below code defines a func which has zero input parameters.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">funcWithZeroInputParams</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">()</span>
                            <span class="p">{</span>
                                <span class="n">Random</span> <span class="n">rnd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>
                                <span class="k">return</span> <span class="n">rnd</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
                            <span class="p">};</span>
</code></pre></div></div>

<p>Func with lambda expression</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">funcWithZeroInputParams</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">().</span><span class="nf">Next</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">sumTwoNumbers</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="predicate">Predicate</h2>

<p>A predicate is also a delegate like Func and Action. It represents a method that takes a single input parameter and returns a bool.</p>

<p>It is defined in System namespace as below:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">obj</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsLowerCase</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">str</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">isLower</span> <span class="p">=</span> <span class="n">IsLowerCase</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">result</span> <span class="p">=</span> <span class="nf">isLower</span><span class="p">(</span><span class="s">"abc"</span><span class="p">);</span>
</code></pre></div></div>

<p>Another way to write above code without using named method</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">isLower</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">(</span><span class="kt">string</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">());};</span>
</code></pre></div></div>

<p>Using lambda expression</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">isLower</span> <span class="p">=</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">());</span>
</code></pre></div></div>

<h2 id="events">Events</h2>

<p>An event is a wrapper around a delegate. It depends on the delegate. Events follows the observer design pattern. There’s a publisher class which generates events and there can be one or multiple subscriber classes which subscribe to the event in order to receive notification (in “push” model) as soon as the event is generated. Events can be declared static, virtual, sealed, and abstract. Event handlers are invoked synchronously if there are multiple subscribers.</p>

<p>An event can be declared in two steps:</p>

<ol>
  <li>Declare a delegate.</li>
  <li>Declare a variable of the delegate with <code class="language-plaintext highlighter-rouge">event</code> keyword.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public delegate void Notify(object o);  // delegate

public class EventPublisher
{
    public event Notify ProcessCompleted; // event

    protected virtual void OnNotify(object o)
    {
        ProcessCompleted.Invoke(o); //calls all event handler methods registered with this event
    }
}

public class Subscriber
{
	public void SubscribeToEvent(EventPublisher publisher)
	{
	    publisher.ProcessCompleted += HandleEvent;
	}
	
	//HandleEvent must match the delegate declared by publisher class.
	private void HandleEvent(object o)
	{
	    //Do some work
	}
}
</code></pre></div></div>

<p>Instead of declaring delegate as above by EventPublisher class, we can use two pre-defnied delegates: EventHandler and EventHandler<TEventArgs></TEventArgs></p>

<p>TEventArgs could be simple or complex type and can be used when we need to send some data back to subscribers. When no data need to be sent, first delegate “EventHandler” should be sufficient.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomEventArgs</span> <span class="p">:</span> <span class="n">EventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">EventTime</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">EventPublisher</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span> <span class="n">ProcessCompletedWithoutArgs</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">CustomEventArgs</span><span class="p">&gt;</span> <span class="n">ProcessCompletedWithArgs</span><span class="p">;</span>
    <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">OnNotifyWithoutArgs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ProcessCompletedWithoutArgs</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">EventArgs</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">OnNotifyWithArgs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ProcessCompletedWithArgs</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="nf">ProcessEventArgs</span><span class="p">(){</span><span class="n">CustomData</span><span class="p">=</span><span class="s">"TestData"</span><span class="p">,</span> <span class="n">EventTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">EventSubscriber</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">SubscribeToEvent</span><span class="p">(</span><span class="n">EventPublisher</span> <span class="n">publisher</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">publisher</span><span class="p">.</span><span class="n">ProcessCompletedWithoutArgs</span> <span class="p">+=</span> <span class="n">HandleEventWithoutArgs</span><span class="p">;</span>
   	    <span class="n">publisher</span><span class="p">.</span><span class="n">ProcessCompletedWithArgs</span> <span class="p">+=</span> <span class="n">HandleEventWithArgs</span><span class="p">;</span>
	<span class="p">}</span>
	
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">HandleEventWithArgs</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">CustomEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
       
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">HandleEventWithoutArgs</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
       
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

</body>

</html>